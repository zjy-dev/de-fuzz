为了实现高效的**断点续传（Resume）**、**世系追踪（Lineage/Genealogy）**以及**覆盖率分析**，我们需要将“种子数据（Payload）”与“元数据（Metadata）”分离，并设计一套规范的命名和存储机制。

注意本系统中的 seed 是后缀为 .seed 的文件, 定义如下:

```text
// The file format is:
// <C Source Code>
// // ||||| JSON_TESTCASES_START |||||
// <JSON Test Cases>
```

以下是详细设计方案：

### 1. 文件存储结构设计

不要将元数据写在种子文件**内部**（即不要修改文件头或追加尾部）。

采用 **“文件名编码 + 旁路元数据（Sidecar/Index）”** 的方式。

建议目录结构如下：

```text
fuzz_out/
├── corpus/              # 存放具体的种子二进制文件
│   ├── id_000000_src_000000_op_init_cov_100.seed
│   ├── id_000001_src_000000_op_flip_cov_102.bin
│   └── ...
├── metadata/            # 存放详细的元数据（可选，如果文件名不够存）
│   ├── id_000000.json
│   └── id_000001.json
└── state/
    └── global_state.json      # 全局状态，用于记录当前处理到哪个ID（断点）
```

---

### 2. 种子文件名命名规则

文件名应该包含最核心的信息，以便在不读取文件内容/元数据库的情况下，LS（列出文件）就能看清大致情况。参考 AFL++的命名风格，建议格式如下：

**格式模板：**
`id-[ID]-src-[ParentID]-cov-[CovIncrement]-[Hash]`

**字段解析：**

- **`id_[000001]`**: **全局唯一递增 ID**。
  - 这是断点重连的核心。你只需要记录“当前 fuzz 到了 ID 500”，下次启动从 501 开始即可。
  - 使用 6 位或 9 位数字补零，方便文件系统排序, 从 1 开始。
- **`src_[000000]`**: **父节点 ID**。
  - 记录它是从哪个种子变异来的。如果是初始种子，ParentID 是 0。
- **`cov_[+12]`**: **覆盖率增量**。
  - 记录该种子相对于父节点（或全局）增加了多少的万分比(百分比乘以 100)。这可以让你快速筛选出高质量种子。
- **`[Hash]`** (可选): 文件内容的 Hash（如 CRC32 或 SHA1 前 8 位）。
  - 用于防止重复存储相同的种子。

**文件名示例：**
`id-000123-src-000042-cov-00132-a1b2c3.seed`

---

### 3. 需要记录的 Meta 信息 (元数据)

虽然文件名存了核心信息，但为了详细分析和断点恢复，你需要一个更详细的结构。这通常存放在单独的 JSON 文件中（每个种子一个，或者一个巨大的 `log.jsonl`），或者在内存中维护定期 Dump。

建议包含以下字段：

#### A. 基础信息 (Basic Info)

- **`id`**: (Int) 自身 ID。
- **`file_path`**: (String) 种子在磁盘的相对路径。
- **`file_size`**: (Int) 文件大小（字节）。
- **`created_at`**: (Timestamp) 创建时间戳。

#### B. 变异世系 (Lineage)

- **`parent_id`**: (Int) 父种子 ID。
- **`depth`**: (Int) 变异深度（初始种子为 0，变异一次+1）。防止变异链过长导致语义丢失。

#### C. 状态与池化 (State & Pooling)

- **`state`**: (Enum) 关键字段，用于断点重连。
  - `PENDING`: 已生成，加入池中，等待被拿出来作为父节点进行下一轮变异。
  - `PROCESSED`: 已经作为父节点被 Fuzz 过了（已出池）。
  - `CRASH`: 该种子导致了崩溃。
  - `TIMEOUT`: 该种子导致超时。

#### D. 运行指标

- `old_cov`: 该种子被编译前的覆盖率万分比（无小数点）
- `new_cov`: 该种子被编译后的覆盖率万分比
- **`cov_incr`**: 覆盖率增量万分比
- **`exec_us`**: (Int) 执行耗时（微秒）。

---

### 4. 断点重连 (Resume) 的实现逻辑

为了方便断点重连，你不需要遍历所有文件。你需要维护一个 **全局状态文件 (`global_state.json`)**。

**Global State 文件内容：**

```json
{
  "last_allocated_id": 1024, // 下一个新种子从 1025 开始命名
  "current_fuzzing_id": 500, // 正在fuzzng ID 为 500 的种子
  "total_coverage": 2500, // 全局总覆盖率万分比
  "queue_stats": {
    // 简单的统计
    "pool_size": 524,
    "processed_count": 500
  }
}
```
