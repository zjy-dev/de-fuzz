name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true # Force clean workspace
          fetch-depth: 0 # Get full history to ensure latest
          persist-credentials: false # Avoid credential persistence

      - name: Complete workspace cleanup
        run: |
          echo "ðŸ§¹ Performing complete workspace cleanup..."
          # Clean all possible cache files
          rm -rf ~/.cache/go-build || true
          rm -rf ~/go/pkg/mod || true
          rm -rf ./bin/ || true
          rm -rf ./logs/ || true
          rm -rf ./.env* || true
          rm -rf ./coverage.* || true
          # Force reset all config files
          git reset --hard HEAD
          git clean -fdx
          echo "âœ… Workspace completely cleaned"

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24.2"

      # Disable cache, force re-download all dependencies
      - name: Force clean Go modules
        run: |
          echo "ðŸ”„ Force cleaning Go modules and build cache..."
          go clean -modcache || true
          go clean -cache || true
          echo "âœ… Go caches cleared"

      - name: Download dependencies (force fresh)
        run: |
          echo "ðŸ“¦ Force downloading fresh dependencies..."
          go mod download -x
          go mod verify
          echo "âœ… Fresh dependencies downloaded and verified"

      # Run unit tests and generate logs
      - name: Run unit tests
        run: |
          mkdir -p artifacts
          echo "=== Running unit tests ==="
          make test-unit 2>&1 | tee artifacts/unit-test.log
        continue-on-error: true

      # Upload test logs (even on failure)
      - name: Upload unit test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-logs-${{ github.run_number }}
          path: artifacts/unit-test.log
