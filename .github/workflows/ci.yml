name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true # å¼ºåˆ¶æ¸…ç†å·¥ä½œç›®å½•
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ç¡®ä¿æœ€æ–°
          persist-credentials: false # é¿å…å‡­æ®æŒä¹…åŒ–

      - name: å®Œæ•´å·¥ä½œåŒºæ¸…ç†
        run: |
          echo "ğŸ§¹ Performing complete workspace cleanup..."
          # æ¸…ç†æ‰€æœ‰å¯èƒ½çš„ç¼“å­˜æ–‡ä»¶
          rm -rf ~/.cache/go-build || true
          rm -rf ~/go/pkg/mod || true
          rm -rf ./bin/ || true
          rm -rf ./logs/ || true
          rm -rf ./.env* || true
          rm -rf ./coverage.* || true
          # å¼ºåˆ¶é‡æ–°è·å–æ‰€æœ‰é…ç½®æ–‡ä»¶
          git reset --hard HEAD
          git clean -fdx
          echo "âœ… Workspace completely cleaned"

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24.2"

      # ç¦ç”¨ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°ä¸‹è½½æ‰€æœ‰ä¾èµ–
      - name: å¼ºåˆ¶æ¸…ç† Go æ¨¡å—
        run: |
          echo "ğŸ”„ Force cleaning Go modules and build cache..."
          go clean -modcache || true
          go clean -cache || true
          echo "âœ… Go caches cleared"

      - name: ä¸‹è½½ä¾èµ–ï¼ˆå¼ºåˆ¶å…¨æ–°ï¼‰
        run: |
          echo "ğŸ“¦ Force downloading fresh dependencies..."
          go mod download -x
          go mod verify
          echo "âœ… Fresh dependencies downloaded and verified"

      # è¿è¡Œå•å…ƒæµ‹è¯•å¹¶ç”Ÿæˆæ—¥å¿—
      - name: Run unit tests
        run: |
          mkdir -p artifacts
          echo "=== Running unit tests ==="
          make test-unit 2>&1 | tee artifacts/unit-test.log
        continue-on-error: true

      # ä¸Šä¼ æµ‹è¯•æ—¥å¿—ï¼ˆå³ä½¿å¤±è´¥ä¹Ÿä¸Šä¼ ï¼‰
      - name: Upload unit test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-logs-${{ github.run_number }}
          path: artifacts/unit-test.log
